<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIPENTAS — BPN NTB · Bidang Pengendalian & Penanganan Sengketa</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<style>
  :root {
    --white: #FFFFFF; --black: #050505; --gray-light: #B3B3B3; --gray-dark: #2B2B2B;
    --bg: #FFFFFF; --surface: #F7F7F7; --border: #E8E8E8; --accent: #050505;
    --text: #050505; --text-muted: #B3B3B3; --text-sub: #2B2B2B;
    --radius: 12px; --radius-sm: 6px;
    --shadow: 0 2px 16px rgba(5,5,5,0.06); --shadow-md: 0 8px 32px rgba(5,5,5,0.10);
    --transition: 0.35s cubic-bezier(0.4,0,0.2,1);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; -webkit-font-smoothing: antialiased; margin: 0; }

  /* ─── HALAMAN LOGIN ─── */
  #login-container { display: flex; min-height: 100vh; width: 100vw; background: var(--white); }
  .login-left { flex: 1.2; background: var(--black); color: var(--white); position: relative; display: flex; flex-direction: column; justify-content: space-between; padding: 60px; overflow: hidden; }
  .login-left::before { content: ''; position: absolute; top: -20%; left: -10%; width: 150%; height: 150%; background: radial-gradient(circle at top left, rgba(255,255,255,0.1) 0%, transparent 60%); pointer-events: none; }
  .login-left-content { position: relative; z-index: 2; max-width: 480px; margin: auto 0; }
  .login-left h1 { font-family: 'DM Serif Display', serif; font-size: 46px; line-height: 1.1; margin-bottom: 20px; }
  .login-left h1 em { font-style: italic; color: rgba(255,255,255,0.5); }
  .login-left p { font-size: 15px; line-height: 1.6; color: rgba(255,255,255,0.7); margin-bottom: 40px; }
  .login-left-footer { position: relative; z-index: 2; font-size: 11px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.08em; }

  .login-right { flex: 1; display: flex; align-items: center; justify-content: center; background: var(--bg); padding: 40px; }
  .login-form-box { width: 100%; max-width: 380px; }
  .login-brand { display: flex; align-items: center; gap: 14px; margin-bottom: 40px; }
  .login-brand-icon { width: 44px; height: 44px; background: var(--black); color: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .login-brand-text h2 { font-family: 'DM Serif Display', serif; font-size: 24px; line-height: 1; }
  .login-brand-text p { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; color: var(--text-muted); text-transform: uppercase; margin-top: 4px; }
  
  .pw-wrapper { position: relative; }
  .pw-toggle { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 0; display: flex; align-items: center; justify-content: center; transition: color 0.2s; }
  .pw-toggle:hover { color: var(--black); }
  
  .login-options { display: flex; justify-content: space-between; align-items: center; margin-top: -6px; margin-bottom: 24px; font-size: 12.5px; }
  .checkbox-group { display: flex; align-items: center; gap: 8px; cursor: pointer; color: var(--text-sub); }
  .checkbox-group input { cursor: pointer; width: 14px; height: 14px; accent-color: var(--black); }
  .login-options a { color: var(--text); font-weight: 500; text-decoration: none; transition: 0.2s; }
  .login-options a:hover { text-decoration: underline; }

  @media (max-width: 900px) { .login-left { display: none; } }

  /* ─── LAYOUT APLIKASI ─── */
  #app-container { display: flex; min-height: 100vh; width: 100vw; }

  /* ─── SIDEBAR ─── */
  .sidebar { width: 260px; background: var(--black); color: var(--white); display: flex; flex-direction: column; position: fixed; left: 0; top: 0; bottom: 0; z-index: 100; transition: transform var(--transition); overflow: hidden; }
  .sidebar::before { content: ''; position: absolute; top: -120px; left: -80px; width: 320px; height: 320px; background: radial-gradient(circle, rgba(179,179,179,0.08) 0%, transparent 70%); pointer-events: none; }
  .sidebar-brand { padding: 28px 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.07); }
  .brand-badge { display: inline-flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.10); border-radius: 20px; padding: 4px 12px 4px 4px; margin-bottom: 14px; }
  .brand-dot { width: 20px; height: 20px; background: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
  .brand-dot svg { width: 10px; height: 10px; }
  .brand-badge span { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 600; letter-spacing: 0.08em; opacity: 0.7; text-transform: uppercase; }
  .brand-title { font-family: 'DM Serif Display', serif; font-size: 22px; line-height: 1.2; color: var(--white); }
  .brand-title em { font-style: italic; color: var(--gray-light); }
  .brand-sub { font-size: 11px; color: rgba(255,255,255,0.4); margin-top: 4px; letter-spacing: 0.02em; line-height: 1.5; }
  
  .sidebar-nav { padding: 16px 12px; flex: 1; overflow-y: auto; }
  .nav-section-label { font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: rgba(255,255,255,0.25); padding: 12px 12px 6px; }
  .nav-item { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; position: relative; margin-bottom: 2px; color: rgba(255,255,255,0.55); font-size: 13.5px; font-weight: 400; user-select: none; }
  .nav-item svg { width: 16px; height: 16px; opacity: 0.7; flex-shrink: 0; }
  .nav-item:hover { background: rgba(255,255,255,0.07); color: var(--white); } .nav-item:hover svg { opacity: 1; }
  .nav-item.active { background: rgba(255,255,255,0.10); color: var(--white); font-weight: 500; } .nav-item.active svg { opacity: 1; }
  .nav-item.active::before { content: ''; position: absolute; left: 0; top: 20%; height: 60%; width: 2px; background: var(--white); border-radius: 2px; }
  .nav-badge { margin-left: auto; background: rgba(255,255,255,0.12); color: rgba(255,255,255,0.6); font-size: 10px; font-weight: 600; padding: 2px 7px; border-radius: 10px; }
  .nav-item.active .nav-badge { background: var(--white); color: var(--black); }
  .sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.07); font-size: 11px; color: rgba(255,255,255,0.25); line-height: 1.6; }

  /* ─── MAIN CONTENT ─── */
  .main { margin-left: 260px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; transition: margin var(--transition); min-width: 0; }
  .topbar { position: sticky; top: 0; z-index: 50; background: rgba(255,255,255,0.92); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 0 36px; height: 64px; display: flex; align-items: center; justify-content: space-between; }
  .topbar-left { display: flex; align-items: center; gap: 12px; }
  .page-crumb { font-size: 12px; color: var(--text-muted); letter-spacing: 0.02em; } .page-crumb span { color: var(--text); font-weight: 500; }
  .topbar-right { display: flex; align-items: center; gap: 16px; }
  .topbar-btn { width: 36px; height: 36px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--white); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-muted); }
  .topbar-btn:hover { border-color: var(--gray-dark); color: var(--text); }
  
  /* DROPDOWN MENU AKUN */
  .dropdown { position: relative; display: inline-block; }
  .user-chip { display: flex; align-items: center; gap: 10px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px 6px 6px; cursor: pointer; transition: all 0.2s; user-select: none; }
  .user-chip:hover { border-color: var(--black); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .user-avatar { width: 28px; height: 28px; background: var(--black); color: var(--white); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; overflow:hidden; }
  .user-avatar img { width:100%; height:100%; object-fit:cover; }
  .user-name { font-size: 12px; font-weight: 500; color: var(--text); }
  .dropdown-menu { position: absolute; top: calc(100% + 8px); right: 0; background: var(--white); border: 1px solid var(--border); border-radius: var(--radius-sm); box-shadow: var(--shadow-md); min-width: 160px; display: none; flex-direction: column; z-index: 1000; overflow: hidden; }
  .dropdown-menu.show { display: flex; animation: fadeDown 0.2s ease; }
  @keyframes fadeDown { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }
  .dropdown-item { padding: 12px 16px; font-size: 13px; color: var(--text); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; text-decoration: none; font-family: 'DM Sans', sans-serif; border:none; background:none; text-align:left; width:100%; }
  .dropdown-item:hover { background: var(--surface); }
  .dropdown-item.danger:hover { color: #C0392B; }

  /* ─── PAGE & COMPONENTS ─── */
  .content { padding: 36px; flex: 1; transition: padding var(--transition); }
  .page { display: none; } .page.active { display: block; animation: pageIn 0.45s cubic-bezier(0.4,0,0.2,1); }
  @keyframes pageIn { from { opacity: 0; transform: translateY(18px); } to { opacity: 1; transform: translateY(0); } }

  .page-header { margin-bottom: 32px; }
  .page-header h1 { font-family: 'DM Serif Display', serif; font-size: 32px; line-height: 1.15; color: var(--text); }
  .page-header h1 em { font-style: italic; color: var(--gray-light); }
  .page-header p { color: var(--text-muted); font-size: 14px; margin-top: 6px; }

  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
  .stat-card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 22px; transition: box-shadow 0.2s, transform 0.2s; cursor: default; position: relative; overflow: hidden; }
  .stat-card::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 2px; background: var(--black); transform: scaleX(0); transform-origin: left; transition: transform 0.3s ease; }
  .stat-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); } .stat-card:hover::after { transform: scaleX(1); }
  .stat-label { font-size: 11px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); margin-bottom: 10px; }
  .stat-value { font-family: 'DM Serif Display', serif; font-size: 36px; line-height: 1; color: var(--text); }
  .stat-meta { font-size: 12px; color: var(--text-muted); margin-top: 6px; } .stat-meta strong { color: var(--text-sub); }

  .dashboard-grid { display: grid; grid-template-columns: 1fr 340px; gap: 20px; }
  .settings-grid { display: grid; grid-template-columns: 340px 1fr; gap: 24px; }
  
  .card { background: var(--white); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; min-width: 0; }
  .card-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .card-title { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.04em; color: var(--text); }
  .card-body { padding: 22px; }
  .card-action { font-size: 12px; color: var(--text-muted); cursor: pointer; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 5px 12px; transition: all 0.2s; background: none; font-family: 'DM Sans', sans-serif; }
  .card-action:hover { border-color: var(--gray-dark); color: var(--text); }

  /* ─── TABEL DATA & SCROLLING ─── */
  .scrollable { overflow-x: auto; width: 100%; -webkit-overflow-scrolling: touch; display: block; }
  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th { text-align: left; padding: 10px 14px; font-family: 'Syne', sans-serif; font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); border-bottom: 1px solid var(--border); white-space: nowrap; }
  /* TD menggunakan nowrap agar tabel memaksa scroll horizontal jika layarnya kecil */
  .data-table td { padding: 12px 14px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
  .data-table tr { transition: background 0.15s; cursor: pointer; } .data-table tr:hover td { background: var(--surface); }
  
  .badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 9px; border-radius: 20px; font-size: 11px; font-weight: 600; white-space: nowrap; }
  .badge-admin { background: #F0F0F0; color: var(--gray-dark); border: 1px solid #E0E0E0; } .badge-court { background: var(--black); color: var(--white); }
  .badge-dot { width: 5px; height: 5px; border-radius: 50%; }
  .status-badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .status-1 { background: #FFF8E1; color: #B7791F; } .status-2 { background: #E8F5E9; color: #2E7D32; } .status-3 { background: #E3F2FD; color: #1565C0; } .status-4 { background: #F3E5F5; color: #6A1B9A; } .status-5 { background: #E8F5E9; color: #1B5E20; } .status-0 { background: var(--surface); color: var(--text-muted); }
  
  .pipeline { display: flex; gap: 4px; align-items: center; flex-wrap: nowrap; overflow: hidden; }
  .pipe-step { flex: 1; height: 4px; background: var(--border); border-radius: 2px; position: relative; min-width: 0; }
  .pipe-step.done { background: var(--black); } .pipe-step.active { background: var(--gray-dark); }

  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; } .form-grid.full { grid-template-columns: 1fr; }
  .form-group { display: flex; flex-direction: column; gap: 6px; } .form-group label { font-size: 11px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); cursor: pointer; }
  .form-control { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 13.5px; color: var(--text); outline: none; transition: border-color 0.2s, box-shadow 0.2s; width: 100%; }
  .form-control:focus { border-color: var(--black); box-shadow: 0 0 0 3px rgba(5,5,5,0.06); }
  .form-control:disabled { background: var(--surface); cursor: not-allowed; opacity: 0.7; }
  select.form-control { cursor: pointer; } textarea.form-control { resize: vertical; min-height: 80px; }
  
  .search-row { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; flex-wrap: wrap; }
  .search-box { flex: 1; min-width: 200px; display: flex; align-items: center; gap: 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 0 14px; background: var(--white); transition: border-color 0.2s, box-shadow 0.2s; }
  .search-box:focus-within { border-color: var(--black); box-shadow: 0 0 0 3px rgba(5,5,5,0.06); } .search-box input { border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 13.5px; color: var(--text); background: none; width: 100%; padding: 10px 0; }
  .filter-select { padding: 10px 14px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: var(--white); font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--text); outline: none; cursor: pointer; }

  .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: var(--radius-sm); font-family: 'DM Sans', sans-serif; font-size: 13.5px; font-weight: 500; cursor: pointer; border: none; outline: none; transition: all 0.2s; white-space: nowrap; }
  .btn-primary { background: var(--black); color: var(--white); } .btn-primary:hover { background: var(--gray-dark); }
  .btn-secondary { background: var(--white); color: var(--text); border: 1px solid var(--border); } .btn-secondary:hover { border-color: var(--gray-dark); }
  .btn-ghost { background: none; color: var(--text-muted); border: none; } .btn-ghost:hover { color: var(--text); }
  .btn-sm { padding: 7px 14px; font-size: 12px; }
  .btn-danger { background: #FFF5F5; color: #C0392B; border: 1px solid #FFD0CC; } .btn-danger:hover { background: #FFE8E5; }
  .btn-full { width: 100%; }
  .divider { height: 1px; background: var(--border); margin: 24px 0; }

  /* ─── DETAIL VIEW & STEPPER ─── */
  .detail-header { background: var(--black); color: var(--white); border-radius: var(--radius); padding: 28px; margin-bottom: 20px; position: relative; overflow: hidden; }
  .detail-header::before { content: ''; position: absolute; right: -40px; top: -40px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.04) 0%, transparent 70%); }
  .detail-case-id { font-family: 'Syne', sans-serif; font-size: 11px; font-weight: 700; letter-spacing: 0.10em; opacity: 0.5; margin-bottom: 8px; }
  .detail-title { font-family: 'DM Serif Display', serif; font-size: 22px; line-height: 1.3; margin-bottom: 10px; }
  .detail-metas { display: flex; gap: 20px; flex-wrap: wrap; } .detail-meta-item { font-size: 12px; opacity: 0.6; } .detail-meta-item strong { opacity: 1; margin-right: 4px; }
  
  .stepper { margin: 20px 0; }
  .step-item { display: flex; gap: 16px; padding: 16px 0; border-bottom: 1px solid var(--border); position: relative; }
  .step-item:last-child { border-bottom: none; }
  .step-num { width: 32px; height: 32px; flex-shrink: 0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700; }
  .step-num.done { background: var(--black); color: var(--white); }
  .step-num.active { background: var(--gray-dark); color: var(--white); }
  .step-num.pending { background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); }
  .step-num.success { background: #1B5E20; color: var(--white); box-shadow: 0 0 0 3px rgba(27, 94, 32, 0.2); }
  .step-content { flex: 1; min-width: 0; }
  .step-content .step-title { font-size: 13.5px; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; }
  .step-content .step-date { font-size: 11px; color: var(--text-muted); margin-bottom: 6px; }
  .step-content .step-note { font-size: 12px; color: var(--text-sub); background: var(--surface); border-radius: var(--radius-sm); padding: 8px 12px; margin-top: 4px; }

  /* ─── MODALS ─── */
  .modal-overlay { position: fixed; inset: 0; z-index: 200; background: rgba(5,5,5,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal { background: var(--white); border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 24px 80px rgba(5,5,5,0.2); transform: translateY(20px) scale(0.97); transition: transform 0.35s cubic-bezier(0.4,0,0.2,1); }
  .modal-overlay.open .modal { transform: none; }
  .modal-header { padding: 22px 24px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--white); z-index: 1; }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 20px; }
  .modal-close { width: 32px; height: 32px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
  .modal-close:hover { background: var(--surface); } .modal-close svg { width: 14px; height: 14px; }
  .modal-body { padding: 24px; } .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

  /* ─── UTILITIES ─── */
  #toast-container { position: fixed; bottom: 28px; right: 28px; z-index: 999; display: flex; flex-direction: column; gap: 10px; }
  .toast { background: var(--black); color: var(--white); padding: 13px 20px; border-radius: var(--radius-sm); font-size: 13px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow-md); animation: toastIn 0.35s cubic-bezier(0.4,0,0.2,1); max-width: 320px; }
  .toast.success { background: #1B5E20; } .toast.error { background: #B71C1C; }
  @keyframes toastIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: none; } }

  ::-webkit-scrollbar { width: 6px; height: 6px; } ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; } ::-webkit-scrollbar-thumb:hover { background: var(--gray-light); }
  
  .progress-bar { background: var(--border); border-radius: 3px; height: 6px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--black); border-radius: 3px; transition: width 0.6s ease; }
  .tabs { display: flex; gap: 2px; background: var(--surface); border-radius: var(--radius-sm); padding: 4px; margin-bottom: 20px; width: fit-content; }
  .tab { padding: 7px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--text-muted); border: none; background: none; font-family: 'DM Sans', sans-serif; }
  .tab.active { background: var(--white); color: var(--text); box-shadow: 0 1px 4px rgba(5,5,5,0.08); } .tab:hover:not(.active) { color: var(--text); }
  .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; } .info-item label { font-size: 10px; font-weight: 700; letter-spacing: 0.08em; text-transform: uppercase; color: var(--text-muted); display: block; margin-bottom: 4px; } .info-item span { font-size: 13.5px; color: var(--text); }

  /* Calendar classes */
  .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; } .cal-month-label { font-family: 'DM Serif Display', serif; font-size: 18px; }
  .cal-nav-btns { display: flex; gap: 6px; } .cal-nav-btn { width: 30px; height: 30px; border: 1px solid var(--border); border-radius: var(--radius-sm); background: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; color: var(--text-muted); } .cal-nav-btn:hover { border-color: var(--black); color: var(--black); } .cal-nav-btn svg { width: 14px; height: 14px; }
  .cal-days-header { display: grid; grid-template-columns: repeat(7, 1fr); margin-bottom: 8px; } .cal-day-name { text-align: center; font-size: 10px; font-weight: 700; letter-spacing: 0.06em; text-transform: uppercase; color: var(--text-muted); padding: 4px 0; }
  .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; } .cal-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 12px; border-radius: var(--radius-sm); cursor: pointer; position: relative; transition: all 0.2s; color: var(--text-sub); flex-direction: column; gap: 2px; } .cal-cell:hover { background: var(--surface); } .cal-cell.other-month { color: var(--text-muted); opacity: 0.4; } .cal-cell.today { background: var(--black); color: var(--white) !important; font-weight: 700; } .cal-cell.holiday { color: #c0392b; font-weight: 600; }
  .cal-cell.has-event::after { content: ''; position: absolute; bottom: 4px; width: 4px; height: 4px; background: var(--black); border-radius: 50%; } .cal-cell.today.has-event::after { background: var(--white); } .cal-cell.holiday.has-event::after { background: #c0392b; }
  .agenda-item { display: flex; gap: 14px; align-items: flex-start; padding: 12px 0; border-bottom: 1px solid var(--border); } .agenda-item:last-child { border-bottom: none; padding-bottom: 0; } .agenda-date-badge { width: 42px; height: 42px; flex-shrink: 0; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius-sm); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 16px; font-weight: 700; line-height: 1; color: var(--text); } .agenda-date-badge small { font-size: 9px; font-weight: 600; text-transform: uppercase; color: var(--text-muted); letter-spacing: 0.06em; margin-top: 2px; }
  .agenda-info .agenda-title { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 3px; } .agenda-info .agenda-meta { font-size: 11px; color: var(--text-muted); }
  .cal-tooltip { position: absolute; background: var(--black); color: var(--white); padding: 6px 10px; border-radius: var(--radius-sm); font-size: 11px; white-space: nowrap; z-index: 20; pointer-events: none; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); opacity: 0; transition: opacity 0.2s; max-width: 200px; white-space: normal; text-align: center; } .cal-cell:hover .cal-tooltip { opacity: 1; } .cal-cell { position: relative; }

  /* MOBILE RESPONSIVE */
  .menu-toggle { display: none; background: none; border: none; cursor: pointer; color: var(--text); padding: 5px; }
  .sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(5,5,5,0.4); z-index: 90; opacity: 0; transition: opacity 0.3s; }
  .sidebar-overlay.active { display: block; opacity: 1; }
  button:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible { outline: 2px solid var(--black); outline-offset: 2px; }

  @media (max-width: 1024px) {
    .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); }
    .main { margin-left: 0; } .menu-toggle { display: block; } .topbar { padding: 0 20px; } .content { padding: 20px; }
  }
  @media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr 1fr; } .form-grid { grid-template-columns: 1fr !important; } .info-grid { grid-template-columns: 1fr; } .dashboard-grid { display: flex; flex-direction: column; } .settings-grid { grid-template-columns: 1fr; } .detail-metas { flex-direction: column; gap: 8px; }
    /* DIHAPUS: Sembunyikan kolom pada mobile, agar tabel tetap lebar dan bisa di-scroll horizontal */
  }
  @media (max-width: 480px) { .stats-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>

<div id="login-container">
  <div class="login-left">
    <div class="login-left-content">
      <h1>Sistem<br>Informasi<br><em>Pengendalian &amp;<br>Penanganan Sengketa</em></h1>
      <p>Portal manajemen data pembatalan hak atas tanah terpadu untuk Kanwil BPN Provinsi Nusa Tenggara Barat.</p>
    </div>
    <div class="login-left-footer">
      Dilindungi oleh sistem otentikasi internal BPN<br>Akses Terbatas
    </div>
  </div>
  
  <div class="login-right">
    <div class="login-form-box">
      <div class="login-brand">
        <div class="login-brand-icon">
          <svg viewBox="0 0 24 24" fill="currentColor" style="width:20px;height:20px;"><circle cx="12" cy="12" r="8"/></svg>
        </div>
        <div class="login-brand-text">
          <h2>SIPENTAS</h2>
          <p>Kanwil BPN Provinsi NTB</p>
        </div>
      </div>
      
      <form onsubmit="handleLogin(event)">
        <div class="form-group" style="margin-bottom:16px">
          <label for="l-username">NIP / Nama Pengguna</label>
          <input type="text" id="l-username" class="form-control" placeholder="Masukkan NIP Anda" required>
        </div>
        <div class="form-group" style="margin-bottom:20px">
          <label for="l-password">Kata Sandi</label>
          <div class="pw-wrapper">
            <input type="password" id="l-password" class="form-control" placeholder="Masukkan kata sandi" required>
            <button type="button" class="pw-toggle" onclick="togglePassword()" title="Lihat/Sembunyikan Sandi">
              <svg id="pw-icon" viewBox="0 0 24 24" width="18" height="18" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>
              </svg>
            </button>
          </div>
        </div>
        
        <div class="login-options">
          <label class="checkbox-group">
            <input type="checkbox" id="l-remember"> Ingat Saya
          </label>
          <a href="javascript:void(0)" onclick="alert('Silakan hubungi Administrator IT (Pusdatin) untuk mereset kata sandi Anda.')">Lupa Kata Sandi?</a>
        </div>
        
        <button type="submit" class="btn btn-primary btn-full" style="font-size:14px; padding:12px">Masuk ke Sistem</button>
      </form>
    </div>
  </div>
</div>

<div id="app-container" style="display:none;">

  <aside class="sidebar">
    <div class="sidebar-brand">
      <div class="brand-badge"><div class="brand-dot"><svg viewBox="0 0 24 24" fill="currentColor" style="color:#050505"><circle cx="12" cy="12" r="5"/></svg></div><span>BPN · NTB</span></div>
      <div class="brand-title">SIPENTAS<em>.</em></div>
      <div class="brand-sub">Sistem Informasi Pengendalian &amp;<br>Penanganan Sengketa</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section-label">Utama</div>
      <div class="nav-item active" onclick="navigateTo('dashboard')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg> Dashboard</div>
      <div class="nav-section-label" style="margin-top:8px">Permohonan Pembatalan</div>
      <div class="nav-item" onclick="navigateTo('list-cacat')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Cacat Administrasi <span class="nav-badge" id="badge-cacat">0</span></div>
      <div class="nav-item" onclick="navigateTo('list-putusan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg> Putusan Pengadilan <span class="nav-badge" id="badge-putusan">0</span></div>
      <div class="nav-item" onclick="navigateTo('tambah')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg> Tambah Permohonan</div>
      <div class="nav-section-label" style="margin-top:8px">Informasi</div>
      <div class="nav-item" onclick="navigateTo('kalender')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg> Kalender Kegiatan</div>
      <div class="nav-item" onclick="navigateTo('tahapan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg> Alur Tahapan</div>
      
      <div class="nav-section-label" style="margin-top:8px">Sistem</div>
      <div class="nav-item" onclick="navigateTo('pengaturan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg> Pengaturan</div>
    </nav>
    <div class="sidebar-footer">Kantor Wilayah BPN<br>Provinsi Nusa Tenggara Barat</div>
  </aside>

  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Menu"><svg viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
        <div class="page-crumb" id="page-crumb">Beranda / <span>Dashboard</span></div>
      </div>
      <div class="topbar-right">
        
        <div class="search-box" style="height: 36px; min-width: 250px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px; height:16px"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="Cari nomor berkas, pemohon..." id="global-search" oninput="if(currentPage==='list-cacat') filterTable('cacat'); else if(currentPage==='list-putusan') filterTable('putusan');" style="padding: 0;">
        </div>

        <button class="topbar-btn" title="Notifikasi"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></button>
        
        <div class="dropdown">
          <div class="user-chip" onclick="toggleUserMenu(event)" title="Menu Akun">
            <div class="user-avatar" id="topbar-avatar-container">
              <img id="topbar-avatar-img" src="" alt="Profile" style="display:none;">
              <span id="topbar-avatar-initials">AD</span>
            </div>
            <span class="user-name" id="topbar-user-name">Admin BPN NTB</span>
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" style="margin-left:4px; opacity:0.5;"><polyline points="6 9 12 15 18 9"></polyline></svg>
          </div>
          <div class="dropdown-menu" id="user-dropdown">
            <div style="padding:12px 16px; border-bottom:1px solid var(--border); font-size:11px; color:var(--text-muted);">Masuk sebagai Administrator</div>
            <a class="dropdown-item" href="javascript:void(0)" onclick="navigateTo('pengaturan')">
              <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> Pengaturan Profil
            </a>
            <button class="dropdown-item danger" onclick="logout()">
              <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg> Keluar / Log Out
            </button>
          </div>
        </div>

      </div>
    </header>

    <div class="content">
      <div class="page active" id="page-dashboard">
        <div class="page-header"><h1>Selamat Datang<em>,</em> di SIPENTAS</h1><p>Sistem Informasi Pengendalian &amp; Penanganan Sengketa — Kanwil BPN NTB</p></div>
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Total Permohonan</div><div class="stat-value" id="stat-total">0</div><div class="stat-meta">Seluruh kategori</div></div>
          <div class="stat-card"><div class="stat-label">Cacat Administrasi</div><div class="stat-value" id="stat-cacat">0</div><div class="stat-meta">Permohonan aktif</div></div>
          <div class="stat-card"><div class="stat-label">Putusan Pengadilan</div><div class="stat-value" id="stat-putusan">0</div><div class="stat-meta">Permohonan aktif</div></div>
          <div class="stat-card"><div class="stat-label">Selesai (SK Terbit)</div><div class="stat-value" id="stat-selesai">0</div><div class="stat-meta">Kasus tuntas</div></div>
        </div>
        <div class="dashboard-grid">
          <div class="dashboard-main">
            <div class="card">
              <div class="card-header"><span class="card-title">Permohonan Terkini</span><button class="card-action" onclick="navigateTo('list-cacat')">Lihat Semua</button></div>
              <div class="scrollable">
                <table class="data-table">
                  <thead><tr><th>No. Berkas</th><th>Pemohon</th><th>Jenis</th><th>Tahapan</th><th>Status</th></tr></thead>
                  <tbody id="recent-cases-tbody"><tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px">Belum ada data</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:20px">
            <div class="card">
              <div class="card-header"><span class="card-title">Kalender</span><button class="card-action" onclick="navigateTo('kalender')">Atur</button></div>
              <div class="card-body" style="padding:16px"><div class="calendar-header"><div class="cal-month-label" id="mini-cal-label"></div><div class="cal-nav-btns"><button class="cal-nav-btn" onclick="miniCalPrev()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg></button><button class="cal-nav-btn" onclick="miniCalNext()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg></button></div></div><div class="cal-days-header"><div class="cal-day-name">Min</div><div class="cal-day-name">Sen</div><div class="cal-day-name">Sel</div><div class="cal-day-name">Rab</div><div class="cal-day-name">Kam</div><div class="cal-day-name">Jum</div><div class="cal-day-name">Sab</div></div><div class="cal-grid" id="mini-cal-grid"></div></div>
            </div>
            <div class="card"><div class="card-header"><span class="card-title">Agenda Mendatang</span></div><div class="card-body" style="padding: 12px 18px"><div id="upcoming-agenda"></div></div></div>
          </div>
        </div>
      </div>

      <div class="page" id="page-list-cacat">
        <div class="page-header"><h1>Cacat <em>Administrasi</em></h1><p>Daftar permohonan pembatalan berdasarkan cacat administrasi</p></div>
        <div class="search-row" style="justify-content: flex-end;">
          <select class="filter-select" id="filter-status-cacat" onchange="filterTable('cacat')"><option value="">Semua Tahapan</option><option value="0">Usulan Masuk</option><option value="1">Telaah Staff</option><option value="2">Penelitian Lapang</option><option value="3">Gelar Kasus</option><option value="4">Penerbitan SK</option><option value="5">Selesai</option></select>
        </div>
        <div class="card"><div class="scrollable"><table class="data-table"><thead><tr><th>No. Berkas</th><th>Kantor Pertanahan</th><th>Pemohon</th><th>Objek Tanah</th><th>Desa/Kecamatan</th><th>Tgl. Usulan</th><th>Tahapan</th><th>Progress</th><th>Aksi</th></tr></thead><tbody id="tbody-cacat"></tbody></table></div></div>
      </div>

      <div class="page" id="page-list-putusan">
        <div class="page-header"><h1>Putusan <em>Pengadilan</em></h1><p>Daftar permohonan pembatalan berdasarkan putusan pengadilan inkracht</p></div>
        <div class="search-row" style="justify-content: flex-end;">
          <select class="filter-select" id="filter-status-putusan" onchange="filterTable('putusan')"><option value="">Semua Tahapan</option><option value="0">Usulan Masuk</option><option value="1">Telaah Staff</option><option value="2">Penelitian Lapang</option><option value="3">Gelar Kasus</option><option value="4">Penerbitan SK</option><option value="5">Selesai</option></select>
        </div>
        <div class="card"><div class="scrollable"><table class="data-table"><thead><tr><th>No. Berkas</th><th>Kantor Pertanahan</th><th>Pemohon</th><th>No. Putusan</th><th>Desa/Kecamatan</th><th>Tgl. Usulan</th><th>Tahapan</th><th>Progress</th><th>Aksi</th></tr></thead><tbody id="tbody-putusan"></tbody></table></div></div>
      </div>

      <div class="page" id="page-tambah">
        <div class="page-header"><h1>Tambah <em>Permohonan</em></h1><p>Input data permohonan pembatalan baru (Tahapan diproses setelah data tersimpan)</p></div>
        <div class="card" style="max-width:820px">
          <div class="card-header"><span class="card-title">Formulir Permohonan</span></div>
          <div class="card-body">
            <div class="tabs" style="margin-bottom:24px">
              <button type="button" class="tab active" onclick="switchFormTab('info')">Informasi Umum</button>
              <button type="button" class="tab" onclick="switchFormTab('detail')">Detail Objek</button>
            </div>
            
            <form id="form-permohonan" onsubmit="submitForm(event)">
              <div id="form-tab-info">
                <div class="form-grid">
                  <div class="form-group"><label for="f-nomorberkas">Nomor Berkas *</label><input type="text" class="form-control" id="f-nomorberkas" placeholder="Contoh: BPN-NTB/CA/2025/001" required></div>
                  <div class="form-group"><label for="f-jenis">Jenis Dasar Permohonan *</label><select class="form-control" id="f-jenis" required><option value="">-- Pilih --</option><option value="cacat">Cacat Administrasi</option><option value="putusan">Putusan Pengadilan</option></select></div>
                  <div class="form-group"><label for="f-kantah">Kantor Pertanahan Pengusul *</label><select class="form-control" id="f-kantah" required><option value="">-- Pilih --</option><option>Kota Mataram</option><option>Lombok Barat</option><option>Lombok Tengah</option><option>Lombok Timur</option><option>Lombok Utara</option><option>Sumbawa</option><option>Sumbawa Barat</option><option>Dompu</option><option>Bima</option><option>Kota Bima</option></select></div>
                  <div class="form-group"><label for="f-tglUsulan">Tanggal Surat Usulan *</label><input type="date" class="form-control" id="f-tglUsulan" required></div>
                  <div class="form-group"><label for="f-pemohon">Nama Pemohon *</label><input type="text" class="form-control" id="f-pemohon" required></div>
                  <div class="form-group"><label for="f-kontak">No. HP / Kontak Pemohon</label><input type="text" class="form-control" id="f-kontak" placeholder="08xxxxxxxxxx"></div>
                  <div class="form-group"><label for="f-pj">Penanggung Jawab Berkas *</label><input type="text" class="form-control" id="f-pj" placeholder="Nama Petugas/Admin Kantah" required></div>
                  
                  <div class="form-group full form-grid" style="grid-template-columns:1fr 1fr"><div class="form-group" id="f-noputs-group" style="display:none"><label for="f-noputs">Nomor Putusan Pengadilan</label><input type="text" class="form-control" id="f-noputs"></div></div>
                  
                  <div class="form-group full" style="grid-column:1/-1;">
                    <label for="f-dokumenusulan">Upload Dokumen Usulan (PDF)</label>
                    <input type="file" class="form-control" id="f-dokumenusulan" accept="application/pdf" style="padding:10px;">
                    <small style="color:var(--text-muted); margin-top:4px; font-size:11px;">Maksimal file 2MB.</small>
                  </div>
                </div>
              </div>
              
              <div id="form-tab-detail" style="display:none">
                <div class="form-grid">
                  <div class="form-group full" style="grid-column:1/-1;">
                    <label for="f-pemeganghak">Nama Pemegang Hak *</label>
                    <input type="text" class="form-control" id="f-pemeganghak" placeholder="Nama yang tertera pada sertipikat" required>
                  </div>

                  <div class="form-group"><label for="f-jenissert">Jenis Sertipikat</label><select class="form-control" id="f-jenissert"><option value="">-- Pilih --</option><option>Hak Milik</option><option>HGB</option><option>HGU</option><option>Hak Pakai</option><option>Hak Pengelolaan</option></select></div>
                  <div class="form-group"><label for="f-nosert">Nomor Sertipikat</label><input type="text" class="form-control" id="f-nosert"></div>
                  <div class="form-group full" style="grid-column:1/-1;"><label for="f-luas">Luas Tanah (m²)</label><input type="number" class="form-control" id="f-luas" placeholder="0"></div>
                  
                  <div class="form-group full" style="grid-column:1/-1; margin-top:10px;"><label>Lokasi / Wilayah Administrasi Objek</label></div>
                  
                  <div class="form-group full" style="grid-column:1/-1;">
                    <label for="f-kabupaten">Kota / Kabupaten *</label>
                    <select class="form-control" id="f-kabupaten" onchange="handleKabupatenChange()" required>
                      <option value="">-- Pilih Kota/Kabupaten --</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="f-kecamatan">Kecamatan *</label>
                    <select class="form-control" id="f-kecamatan" onchange="handleKecamatanChange()" disabled required>
                      <option value="">-- Pilih Kecamatan --</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="f-desa">Desa / Kelurahan *</label>
                    <select class="form-control" id="f-desa" disabled required>
                      <option value="">-- Pilih Desa/Kelurahan --</option>
                    </select>
                  </div>
                  
                  <div class="form-group full" style="grid-column:1/-1; margin-top:10px;">
                    <label for="f-dokumenbt">Upload Dokumen Buku Tanah / Surat Ukur (PDF)</label>
                    <input type="file" class="form-control" id="f-dokumenbt" accept="application/pdf" style="padding:10px;">
                    <small style="color:var(--text-muted); margin-top:4px; font-size:11px;">Maksimal file 2MB.</small>
                  </div>

                  <div class="form-group full" style="grid-column:1/-1"><label for="f-uraian">Uraian Singkat Kasus</label><textarea class="form-control" id="f-uraian" style="min-height:100px"></textarea></div>
                </div>
              </div>
              
              <div class="divider"></div>
              <div style="display:flex;gap:10px;justify-content:flex-end">
                <button type="button" class="btn btn-secondary" onclick="navigateTo('dashboard')">Batal</button>
                <button type="button" class="btn btn-secondary" id="btn-prev-tab" style="display:none" onclick="prevFormTab()">← Kembali</button>
                <button type="button" class="btn btn-primary" id="btn-next-tab" onclick="nextFormTab()">Lanjut →</button>
                <button type="submit" class="btn btn-primary" id="btn-submit" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13"/><polyline points="7 3 7 8 15 8"/></svg> Simpan Data Usulan</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="page" id="page-detail">
        <button class="btn btn-ghost btn-sm" onclick="goBackFromDetail()" style="margin-bottom:16px"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg> Kembali</button>
        <div id="detail-content"></div>
      </div>

      <div class="page" id="page-kalender"><div class="page-header"><h1>Kalender <em>Kegiatan</em></h1></div><div style="display:grid;grid-template-columns:1fr 300px;gap:24px" id="calendar-layout"><div class="card"><div class="card-header"><div style="display:flex;align-items:center;gap:16px"><span class="cal-month-label" id="full-cal-label" style="font-family:'DM Serif Display',serif;font-size:20px"></span><div class="cal-nav-btns"><button class="cal-nav-btn" onclick="fullCalPrev()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg></button><button class="cal-nav-btn" onclick="fullCalToday()">Hari Ini</button><button class="cal-nav-btn" onclick="fullCalNext()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="9 18 15 12 9 6"/></svg></button></div></div><div style="display:flex;gap:16px;font-size:11px;align-items:center"><span style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:#050505;display:inline-block"></span>Agenda</span><span style="display:flex;align-items:center;gap:6px"><span style="width:10px;height:10px;border-radius:50%;background:#c0392b;display:inline-block"></span>Libur Nasional</span></div></div><div class="card-body"><div class="cal-days-header" style="grid-template-columns:repeat(7,1fr)"><div class="cal-day-name" style="color:#c0392b">Min</div><div class="cal-day-name">Sen</div><div class="cal-day-name">Sel</div><div class="cal-day-name">Rab</div><div class="cal-day-name">Kam</div><div class="cal-day-name">Jum</div><div class="cal-day-name">Sab</div></div><div class="cal-grid" id="full-cal-grid" style="gap:4px"></div></div></div><div style="display:flex;flex-direction:column;gap:16px"><div class="card"><div class="card-header"><span class="card-title">Tambah Kegiatan</span></div><div class="card-body"><div class="form-group" style="margin-bottom:12px"><label for="new-event-date">Tanggal</label><input type="date" class="form-control" id="new-event-date"></div><div class="form-group" style="margin-bottom:12px"><label for="new-event-title">Judul Kegiatan</label><input type="text" class="form-control" id="new-event-title"></div><div class="form-group" style="margin-bottom:16px"><label for="new-event-desc">Keterangan (opsional)</label><textarea class="form-control" id="new-event-desc" style="min-height:60px"></textarea></div><button class="btn btn-primary" style="width:100%" onclick="addCalendarEvent()">Tambah Kegiatan</button></div></div><div class="card" style="flex:1"><div class="card-header"><span class="card-title">Kegiatan Bulan Ini</span></div><div class="card-body" style="padding:12px 16px;max-height:350px;overflow-y:auto" id="events-list-panel"></div></div></div></div></div>
      <div class="page" id="page-tahapan"><div class="page-header"><h1>Alur <em>Tahapan</em></h1></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px"><div class="card"><div class="card-header"><span class="card-title">Cacat Administrasi</span></div><div class="card-body"><div class="stepper" id="stepper-alur"></div></div></div><div class="card"><div class="card-header"><span class="card-title">Putusan Pengadilan</span></div><div class="card-body"><div class="stepper" id="stepper-alur-2"></div></div></div></div></div>

      <div class="page" id="page-pengaturan">
        <div class="page-header">
          <h1>Pengaturan <em>Akun</em></h1>
          <p>Kelola profil pengguna, preferensi data, dan keamanan akun Anda</p>
        </div>

        <div class="settings-grid">
          <div style="display:flex; flex-direction:column; gap:24px;">
            <div class="card">
              <div class="card-header"><span class="card-title">Foto Profil</span></div>
              <div class="card-body" style="text-align:center;">
                <div style="width:130px; height:130px; border-radius:50%; background:var(--surface); margin:0 auto 16px; display:flex; align-items:center; justify-content:center; border:2px dashed var(--border); overflow:hidden; position:relative;">
                  <img id="profile-preview-img" src="" alt="Preview" style="width:100%; height:100%; object-fit:cover; display:none;">
                  <span id="profile-preview-initials" style="font-family:'Syne',sans-serif; font-size:36px; font-weight:700; color:var(--text-muted);">AD</span>
                </div>
                <input type="file" id="upload-avatar" accept="image/jpeg, image/png" style="display:none" onchange="handleAvatarUpload(event)">
                <button type="button" class="btn btn-secondary btn-sm" onclick="document.getElementById('upload-avatar').click()">
                  <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                  Ganti Foto
                </button>
                <p style="font-size:11px; color:var(--text-muted); margin-top:12px;">Format JPG atau PNG. Maks 2MB.</p>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><span class="card-title">Ubah Kata Sandi</span></div>
              <div class="card-body">
                <form onsubmit="handleUbahSandi(event)">
                  <div class="form-group" style="margin-bottom:14px">
                    <label for="s-old-pass">Sandi Lama</label>
                    <input type="password" id="s-old-pass" class="form-control" required>
                  </div>
                  <div class="form-group" style="margin-bottom:14px">
                    <label for="s-new-pass">Sandi Baru</label>
                    <input type="password" id="s-new-pass" class="form-control" required>
                  </div>
                  <div class="form-group" style="margin-bottom:20px">
                    <label for="s-confirm-pass">Konfirmasi Sandi Baru</label>
                    <input type="password" id="s-confirm-pass" class="form-control" required>
                  </div>
                  <button type="submit" class="btn btn-primary btn-full">Perbarui Sandi</button>
                </form>
              </div>
            </div>
          </div>

          <div class="card" style="height:fit-content;">
            <div class="card-header"><span class="card-title">Informasi Data Diri</span></div>
            <div class="card-body">
              <form onsubmit="handleSimpanProfil(event)">
                <div class="form-grid">
                  <div class="form-group full" style="grid-column:1/-1;">
                    <label for="p-nama">Nama Lengkap</label>
                    <input type="text" id="p-nama" class="form-control" value="Admin BPN NTB" required>
                  </div>
                  <div class="form-group">
                    <label for="p-nip">NIP</label>
                    <input type="text" id="p-nip" class="form-control" value="198001012005011001" required>
                  </div>
                  <div class="form-group">
                    <label for="p-jabatan">Jabatan</label>
                    <input type="text" id="p-jabatan" class="form-control" value="Administrator Sistem">
                  </div>
                  <div class="form-group">
                    <label for="p-email">Alamat Email</label>
                    <input type="email" id="p-email" class="form-control" value="admin.ntb@atrbpn.go.id" required>
                  </div>
                  <div class="form-group">
                    <label for="p-hp">Nomor Handphone</label>
                    <input type="text" id="p-hp" class="form-control" value="081234567890">
                  </div>
                </div>
                <div class="divider"></div>
                <div style="display:flex; justify-content:flex-end;">
                  <button type="submit" class="btn btn-primary">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    Simpan Perubahan
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-agenda">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-agenda-title"></div><button class="modal-close" onclick="closeModal('modal-agenda')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" id="modal-agenda-body"></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-agenda')">Tutup</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-tahapan">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Update Tahapan</div><button class="modal-close" onclick="closeModal('modal-tahapan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <div class="modal-body" id="modal-tahapan-body"></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-tahapan')">Batal</button><button class="btn btn-primary" onclick="saveTahapanUpdate()">Simpan & Unggah</button></div>
  </div>
</div>

<div class="modal-overlay" id="modal-view-tahapan">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Detail Tahapan</div>
      <button class="modal-close" onclick="closeModal('modal-view-tahapan')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body" id="modal-view-tahapan-body"></div>
    <div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('modal-view-tahapan')">Tutup</button><button class="btn btn-primary" id="btn-edit-tahapan">Edit Data</button></div>
  </div>
</div>

<div id="toast-container"></div>

<script>
// ══════════════════════════════════════════════════════════
// 1. DATA MASTER & SISTEM WILAYAH NTB (KABUPATEN -> KECAMATAN -> DESA)
// ══════════════════════════════════════════════════════════
const rawNTB = {
  "Kota Mataram": {
    "Ampenan": "Ampenan Selatan,Ampenan Tengah,Ampenan Utara,Banjar,Bintaro,Dayan Peken,Kebun Sari,Pande Besi,Pejeruk,Taman Sari",
    "Cakranegara": "Cakranegara Barat,Cakranegara Selatan,Cakranegara Selatan Baru,Cakranegara Timur,Cakranegara Utara,Cakra Barat,Karang Taliwang,Mayura,Sayang-sayang,Taliwang",
    "Mataram": "Mataram Timur,Pageangan,Pejanggik,Punia,Pagutan,Pagutan Barat,Pagutan Timur",
    "Sandubaya": "Abian Tubuh Baru,Babakan,Dasan Cermen,Mandalika,Selagalas,Turida,Bertais",
    "Sekarbela": "Jempong Baru,Karang Pule,Kekalik Jaya,Tanjung Karang,Tanjung Karang Permai",
    "Selaparang": "Dasan Agung,Dasan Agung Baru,Gomong,Karang Baru,Mataram Barat,Monjok,Monjok Barat,Monjok Timur,Rembiga"
  },
  "Kota Bima": {
    "Asakota": "Jatibaru,Jatibaru Timur,Jatiwangi,Kolo,Melayu,Ule",
    "Mpunda": "Lewirato,Mande,Manggemaci,Matakando,Monggonao,Panggi,Penatoi,Sadia,Santi",
    "Raba": "Kendo,Nitu,Ntobo,Penaraga,Rabangodu Selatan,Rabangodu Utara,Raba Dompu Barat,Raba Dompu Timur,Rite,Rontu",
    "Rasanae Barat": "Dara,Nae,Pane,Paruga,Tanjung",
    "Rasanae Timur": "Dodu,Kumbe,Kumpa,Nungga,Oimbo,Lelamase"
  },
  "Kabupaten Lombok Barat": {
    "Batu Layar": "Batu Layar,Batu Layar Barat,Bengkaung,Lembah Sari,Meninting,Pusuk Lestari,Sandik,Senggigi,Senteluk",
    "Gerung": "Babussalam,Banyu Urip,Beleka,Dasan Geres,Dasan Tapen,Gapuk,Gerung Selatan,Gerung Utara,Kebun Ayu,Mesanggok,Suka Makmur,Tempos",
    "Gunungsari": "Bukittinggi,Dopang,Gelangsar,Gunungsari,Jatisela,Kekait,Kekeri,Mekarsari,Midang,Nambik,Penimbung,Ranjok,Sesela,Taman Sari",
    "Kediri": "Banyumulek,Dasan Baru,Gelogor,Jagaraga Indah,Kediri,Kediri Selatan,Lelede,Montong Are,Ombe Baru,Rumak",
    "Kuripan": "Giri Sasak,Jagaraga,Kuripan,Kuripan Selatan,Kuripan Timur,Kuripan Utara",
    "Labuapi": "Bagik Polak,Bagik Polak Barat,Bajur,Bengkel,Dasan Tapen,Karang Bongkot,Kuranji,Kuranji Dalang,Labuapi,Merembu,Perampuan,Terong Tawah",
    "Lembar": "Bakong,Eyat Mayang,Jembatan Gantung,Jembatan Kembar,Jembatan Kembar Timur,Lembar,Lembar Selatan,Mareje,Mareje Timur,Sekotong Timur",
    "Lingsar": "Batu Kumbung,Batu Mekar,Bug-bug,Dasan Geria,Duman,Gegelang,Gegerung,Karang Bayan,Langko,Lingsar,Peteluan Indah,Saribaye,Sigerongan",
    "Narmada": "Badrain,Batu Kuta,Buwun Sejati,Dasan Tereng,Gerimax Indah,Golong,Krama Jaya,Lebah Sempaga,Lembuak,Mekarsari,Narmada,Nyur Lembang,Pakuan,Peresak,Peru,Puyot,Sedau,Selat,Sesaot,Suranadi,Tanak Beak",
    "Sekotong": "Batu Putih,Buwun Mas,Cendi Manik,Gili Gede Indah,Kedaro,Pelangan,Sekotong Barat,Sekotong Tengah,Taman Baru"
  },
  "Kabupaten Lombok Utara": {
    "Bayan": "Akar-Akar,Anyar,Bayan,Karang Bajo,Loloan,Mumbul Sari,Sambik Elen,Senaru,Sukadana",
    "Gangga": "Bentek,Genggelang,Gondang,Rempek,Sambik Bangkol",
    "Kayangan": "Dangiang,Gumantar,Kayangan,Pendua,Salut,Santong,Selengen,Sesait",
    "Pemenang": "Gili Indah,Malaka,Menggala,Pemenang Barat,Pemenang Timur",
    "Tanjung": "Jenggala,Medana,Sigar Penjalin,Sokong,Tanjung,Tegal Maja,Teniga"
  },
  "Kabupaten Lombok Tengah": {
    "Batukliang": "Aik Darek,Barabali,Beber,Bujak,Lantan,Mantang,Mekar Bersatu,Pagutan,Peresak,Tampak Siring",
    "Batukliang Utara": "Aik Berik,Aik Bukak,Karang Sidemen,Lelong,Mas-Mas,Setiling,Teratak,Tratak",
    "Janapria": "Bakan,Durian,Janapria,Jango,Keria,Langgo,Lekor,Loangmaka,Pendem,Saba,Selebung,Setuta",
    "Jonggat": "Barejulat,Batutulis,Bonder,Bunkate,Gemel,Jelantik,Nyerot,Pengenjek,Puyung,Sukarara,Ubung",
    "Kopang": "Aik Bual,Bebuak,Darmaji,Dasan Baru,Kopang Rembiga,Lendang Are,Monggas,Muncan,Semparu,Wajageseng",
    "Praya": "Aik Mual,Bunut Baok,Gerunung,Jago,Leneng,Mekar Damai,Mertak Tombok,Panji Sari,Pejanggik,Prapen,Praya,Renteng,Semayan,Tiwugalih,Tonjeng",
    "Praya Barat": "Banyu Urip,Batujai,Bonder,Kateng,Mangkung,Mekar Sari,Penujak,Selong Belanak,Setanggor,Tanak Rarang",
    "Praya Barat Daya": "Batu Jangkih,Darek,Kabul,Montong Ajan,Montong Sapah,Pandan Indah,Pelambik,Ranggagata,Serage",
    "Praya Tengah": "Batunyala,Beraim,Dakung,Gerantung,Jero Gunung,Jurang Jaler,Kelebuh,Lajut,Pejanggik,Pengadang,Prai Meke,Sasake",
    "Praya Timur": "Beleka,Bilelando,Ganti,Kidang,Landah,Marong,Mujur,Sengkerang,Semoyang,Sukaraja",
    "Pringgarata": "Arjangka,Bagu,Bilebante,Menemeng,Murbaya,Pemepek,Pringgarata,Sepakek,Sintung",
    "Pujut": "Bangkat Parak,Gapura,Kawo,Ketara,Kuta,Mertak,Pengengat,Prabu,Rembitan,Sengkol,Sukadana,Teruwai,Tumpak"
  },
  "Kabupaten Lombok Timur": {
    "Aikmel": "Aik Prapa,Aikmel,Aikmel Barat,Aikmel Timur,Aikmel Utara,Bagik Nyaka Santri,Kembang Kerang,Kembang Kerang Daya,Keroya,Toya",
    "Jerowaru": "Batu Nampar,Batu Nampar Selatan,Ekas Buana,Jerowaru,Kwang Rundun,Pene,Pemongkong,Pandan Wangi,Pare Mas,Sekaroh,Sepapan,Serewe,Seriwe,Sukaraja,Wakan",
    "Keruak": "Batu Putik,Dane Rase,Ketapang Raya,Keruak,Mendana Raya,Montong Belae,Pijot,Pijot Utara,Pulau Maringkik,Selebung Ketangga,Sepit,Setungkep Lingsar,Tanjung Luar",
    "Labuhan Haji": "Banjarsari,Ijobalit,Kertasari,Korleko,Korleko Selatan,Labuhan Haji,Penedagandor,Teros,Tirtanadi",
    "Masbagik": "Danger,Kesik,Kumbang,Masbagik Selatan,Masbagik Timur,Masbagik Utara,Masbagik Utara Baru,Paok Motong",
    "Montong Gading": "Jenggik,Jenggik Utara,Kilang,Lendang Nangka,Lendang Nangka Utara,Montong Betok,Pringgajurang,Pringgajurang Utara",
    "Pringgabaya": "Anggaraksa,Apitaik,Batuyang,Gunung Malang,Kerumut,Pringgabaya,Pringgabaya Utara,Pohgading,Pohgading Timur,Seruni Mumbul,Tanak Gadang",
    "Pringgasela": "Aikdewik,Jurit,Jurit Baru,Pengadangan,Pengadangan Barat,Pringgasela,Pringgasela Selatan,Pringgasela Timur,Rempung,Suela",
    "Sakra": "Kabar,Keselet,Moyot,Rumbuk,Rumbuk Timur,Sakra,Sakra Selatan,Songak,Suwangi",
    "Sakra Barat": "Borok Toyang,Boyemare,Bungtiang,Gadungmas,Gunung Rajak,Jerogunung,Kembang Are,Mengkuru,Montong Beter,Pematung,Pejaring,Pengkelak Mas,Rensing,Rensing Bat,Rensing Raya,Sukarara",
    "Sakra Timur": "Gelanggang,Gereneng,Gereneng Timur,Lepak,Lenting,Menceh,Montong Tangi,Padak Guar,Surabaya,Surabaya Utara",
    "Sambelia": "Bagik Manis,Belanting,Dadap,Darakunci,Gunung Rajak,Labuhan Pandan,Madayin,Obel Obel,Padak Guar,Sambelia,Senanggalih,Sugian",
    "Selong": "Denggen,Denggen Timur,Kelayu Selatan,Kelayu Utara,Kembang Sari,Majidi,Pancor,Rakam,Sandubaya,Sekarteja,Selong",
    "Sembalun": "Bilok Petung,Sajang,Sembalun,Sembalun Bumbung,Sembalun Lawang,Sembalun Timba Gading",
    "Sikur": "Gelora,Kembang Kuning,Kota Raja,Loyok,Montong Baan,Montong Baan Selatan,Semaya,Sikur,Sikur Barat,Sikur Selatan,Tete Batu,Tetebatu Selatan",
    "Suela": "Ketangga,Mekar Sari,Perigi,Puncak Jeringo,Sapit,Selaparang,Suela,Suntalangu",
    "Sukamulia": "Dasan Lekong,Jantuk,Nyiur Tebel,Padamara,Paok Pampang,Setanggor,Setanggor Selatan,Sukamulia,Sukamulia Timur",
    "Suralaga": "Anjani,Bagik Payung,Bagik Payung Selatan,Bagik Payung Timur,Bintang Rinjani,Dasan Borok,Dames Damai,Gapuk,Gerung Permai,Kerongkong,Paok Lombok,Suralaga,Tumbuh Mulia,Waringin",
    "Terara": "Embung Kandong,Embung Raja,Jenggik,Kalianyar,Lando,Leming,Pandan Dure,Rarang,Rarang Bat,Rarang Selatan,Rarang Tengah,Santong,Selagik,Suradadi,Terara",
    "Wanasaba": "Bandok,Bebidas,Karang Baru,Karang Baru Timur,Mamben Daya,Mamben Lauk,Mamben Baru,Otak Desa,Tembeng Putik,Wanasaba,Wanasaba Daya,Wanasaba Lauk",
    "Lenek": "Lenek,Lenek Baru,Lenek Daya,Lenek Duren,Lenek Kalibambang,Lenek Lauk,Lenek Pasiraman,Lenek Pesiraman,Lenek Ramban Biak,Sukarema"
  },
  "Kabupaten Sumbawa": {
    "Alas": "Alas,Alas Barat,Kalimango,Pulau Bungin",
    "Alas Barat": "Gontar,Labuhan Mapin,Usar Mapin",
    "Batu Lanteh": "Batudulang,Kelungkung,Tepal",
    "Buer": "Labuhan Burung,Pulau Kaung",
    "Empang": "Empang Atas,Empang Bawah,Jotang",
    "Labangka": "Labangka,Sekokat,Suka Damai",
    "Labuhan Badas": "Labuhan Badas,Labuhan Sumbawa,Karang Dima",
    "Lantung": "Lantung,Sepukur",
    "Lape": "Lape,Dete",
    "Lenangguar": "Lenangguar,Ledang",
    "Lopok": "Lopok,Mama,Langam",
    "Lunyuk": "Lunyuk Ode,Lunyuk Rea",
    "Maronge": "Maronge,Simu",
    "Moyo Hilir": "Moyo,Olat Rawa",
    "Moyo Hulu": "Semamung,Batu Bulan",
    "Moyo Utara": "Sebewe,Songkar",
    "Orong Telu": "Kelawis,Senawang",
    "Plampang": "Plampang,Sepakat,Muer",
    "Rhee": "Rhee,Sampe",
    "Ropang": "Ropang,Ranan",
    "Sumbawa": "Brang Bara,Lempeh,Pekat,Samapuin,Bugis,Brang Biji,Seketeng,Uma Sima",
    "Tarano": "Tarano,Banda",
    "Unter Iwes": "Kerato,Pelita",
    "Utan": "Utan,Motong,Sabedo"
  },
  "Kabupaten Sumbawa Barat": {
    "Brang Ene": "Kalimantong,Mura",
    "Brang Rea": "Bangkat Monteh,Lamuntet,Tepas",
    "Jereweh": "Belo,Beru,Goa",
    "Maluk": "Benete,Bukit Damai,Maluk,Pasir Putih",
    "Poto Tano": "Kertasari,Mantar,Poto Tano",
    "Sekongkang": "Sekongkang Atas,Sekongkang Bawah,Tongo",
    "Seteluk": "Air Suning,Kelanir,Seteluk Atas,Seteluk Tengah",
    "Taliwang": "Bugis,Dalam,Kuang,Menala,Sampir,Telaga Bertong"
  },
  "Kabupaten Dompu": {
    "Dompu": "Bada,Bali,Dorebara,Karijawa,Kandai I,Potu",
    "Hu'u": "Adu,Daha,Hu'u",
    "Kempo": "Doro Kobo,Kempo,Ta'a",
    "Kilo": "Ki Wu,Lasi,Malaju",
    "Manggelewa": "Banggo,Doromelo,Nusa Jaya",
    "Pajo": "Jambu,Lepadi,Rangga",
    "Pekat": "Calabai,Kadindi,Pekat",
    "Woja": "Baka Jaya,Monta Baru,Simpasai,Wawonduru"
  },
  "Kabupaten Bima": {
    "Ambalawi": "Kole,Mawu,Rite",
    "Belo": "Cenggu,Ngali,Renda",
    "Bolo": "Bontokape,Leu,Rato,Sila",
    "Donggo": "Doridungga,Kala,O'o",
    "Lambitu": "Kaboro,Kuta,Sambori",
    "Lambu": "Hidirasa,Kaleo,Lambu",
    "Langgudu": "Doro O'o,Rupe,Waworada",
    "Mada Pangga": "Bolo,Dena,Monggo",
    "Monta": "Baralau,Monta,Tangga",
    "Palibelo": "Nata,Ntonggu,Panda",
    "Parado": "Kanca,Lere,Paradowane",
    "Sanggar": "Boro,Kore,Oi Saro",
    "Sape": "Bugis,Naru Barat,Sangia",
    "Soromandi": "Bajo,Kananta,Sampungu",
    "Tambora": "Kawinda Nae,Oi Bura",
    "Wawo": "Kambita,Maria,Ntori",
    "Wera": "Bala,Ntoke,Tawali",
    "Woha": "Donggobolo,Naru,Rabakodo,Talabiu,Tente"
  }
};

// Merubah string kompresi menjadi Objek JS rapi untuk dropdown
const ntbData = {};
for (const kab in rawNTB) {
  ntbData[kab] = {};
  for (const kec in rawNTB[kab]) {
    ntbData[kab][kec] = rawNTB[kab][kec].split(',').sort();
  }
}

// Fungsi Inisialisasi Kota/Kabupaten
function initWilayah() {
  const kabSelect = document.getElementById('f-kabupaten');
  if(!kabSelect) return;
  kabSelect.innerHTML = '<option value="">-- Pilih Kota/Kabupaten --</option>';
  Object.keys(ntbData).sort().forEach(kab => {
    kabSelect.add(new Option(kab, kab));
  });
}

function handleKabupatenChange() {
  const kab = document.getElementById('f-kabupaten').value;
  const kecSelect = document.getElementById('f-kecamatan');
  const desaSelect = document.getElementById('f-desa');
  
  kecSelect.innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
  desaSelect.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
  desaSelect.disabled = true;

  if (kab && ntbData[kab]) {
    kecSelect.disabled = false;
    Object.keys(ntbData[kab]).sort().forEach(kec => {
      kecSelect.add(new Option(kec, kec));
    });
  } else {
    kecSelect.disabled = true;
  }
}

function handleKecamatanChange() {
  const kab = document.getElementById('f-kabupaten').value;
  const kec = document.getElementById('f-kecamatan').value;
  const desaSelect = document.getElementById('f-desa');
  
  desaSelect.innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';

  if (kab && kec && ntbData[kab][kec]) {
    desaSelect.disabled = false;
    ntbData[kab][kec].forEach(desa => {
      desaSelect.add(new Option(desa, desa));
    });
    desaSelect.add(new Option("Lainnya...", "Lainnya"));
  } else {
    desaSelect.disabled = true;
  }
}


// ══════════════════════════════════════════════════════════
// 2. OTENTIKASI & LOGIKA LOGIN / LOGOUT
// ══════════════════════════════════════════════════════════
function checkLogin() {
  const isLoggedIn = localStorage.getItem('sipentas-logged-in');
  if (isLoggedIn === 'true') {
    document.getElementById('login-container').style.display = 'none';
    document.getElementById('app-container').style.display = 'flex';
  } else {
    document.getElementById('login-container').style.display = 'flex';
    document.getElementById('app-container').style.display = 'none';
  }
}

function handleLogin(e) {
  e.preventDefault();
  const user = document.getElementById('l-username').value;
  const pass = document.getElementById('l-password').value;
  
  if (user === 'admin' && pass === 'admin123') {
    localStorage.setItem('sipentas-logged-in', 'true');
    showToast('Login berhasil! Selamat datang.', 'success');
    document.getElementById('l-password').value = '';
    checkLogin();
  } else {
    showToast('Kredensial tidak valid, silakan periksa kembali.', 'error');
  }
}

function toggleUserMenu(e) {
  e.stopPropagation();
  document.getElementById('user-dropdown').classList.toggle('show');
}

window.addEventListener('click', function(e) {
  const dropdown = document.getElementById('user-dropdown');
  if(dropdown && dropdown.classList.contains('show')) dropdown.classList.remove('show');
});

function logout() {
  if(confirm('Apakah Anda yakin ingin keluar dari sistem?')) {
    localStorage.removeItem('sipentas-logged-in');
    checkLogin();
    showToast('Anda telah keluar.', 'success');
  }
}

function togglePassword() {
  const input = document.getElementById('l-password');
  const icon = document.getElementById('pw-icon');
  if (input.type === 'password') {
    input.type = 'text';
    icon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
  } else {
    input.type = 'password';
    icon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
  }
}


// ══════════════════════════════════════════════════════════
// 3. FITUR PENGATURAN PROFIL
// ══════════════════════════════════════════════════════════
async function handleAvatarUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) { showToast('Gagal: Ukuran foto maksimal 2MB!', 'error'); return; }
  try {
    const base64Image = await readFileAsBase64(file);
    document.getElementById('profile-preview-img').src = base64Image;
    document.getElementById('profile-preview-img').style.display = 'block';
    document.getElementById('profile-preview-initials').style.display = 'none';
    
    document.getElementById('topbar-avatar-img').src = base64Image;
    document.getElementById('topbar-avatar-img').style.display = 'block';
    document.getElementById('topbar-avatar-initials').style.display = 'none';

    showToast('Foto profil berhasil diperbarui!', 'success');
  } catch (error) { showToast('Gagal memuat gambar.', 'error'); }
}
function handleSimpanProfil(e) { e.preventDefault(); const namaBaru = document.getElementById('p-nama').value; if(namaBaru) document.getElementById('topbar-user-name').textContent = namaBaru; showToast('Data diri berhasil disimpan!', 'success'); }
function handleUbahSandi(e) { e.preventDefault(); const baru = document.getElementById('s-new-pass').value; const konfirm = document.getElementById('s-confirm-pass').value; if (baru !== konfirm) { showToast('Konfirmasi sandi tidak cocok!', 'error'); return; } showToast('Kata sandi berhasil diperbarui!', 'success'); e.target.reset(); }


// ══════════════════════════════════════════════════════════
// 4. UTILITAS UMUM
// ══════════════════════════════════════════════════════════
function escapeHTML(str) { if (typeof str !== 'string') return str; return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }
function formatNumber(num) { if (!num) return '0'; return new Intl.NumberFormat('id-ID').format(num); }
function readFileAsBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); reader.readAsDataURL(file); }); }
function toggleSidebar() { const sidebar = document.querySelector('.sidebar'); const overlay = document.querySelector('.sidebar-overlay'); if (sidebar) sidebar.classList.toggle('open'); if (overlay) overlay.classList.toggle('active'); }
function fmtDate(str) { if (!str) return '-'; const d = new Date(str); return isNaN(d) ? str : `${d.getDate()} ${MONTHS[d.getMonth()]} ${d.getFullYear()}`; }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
function showToast(msg, type = '') { const c = document.getElementById('toast-container'), t = document.createElement('div'); t.className = 'toast ' + type; t.innerHTML = msg; c.appendChild(t); setTimeout(() => t.remove(), 3000); }
document.querySelectorAll('.modal-overlay').forEach(ov => { ov.addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); }); });


// ══════════════════════════════════════════════════════════
// 5. DATABASE PENYIMPANAN
// ══════════════════════════════════════════════════════════
let cases = JSON.parse(localStorage.getItem('sipentas-cases') || '[]');
let calendarEvents = JSON.parse(localStorage.getItem('sipentas-events') || '[]');

const TAHAPAN_LABELS = ['Surat Usulan dari Kantah', 'Telaah Staff', 'Penelitian Lapang', 'Gelar Kasus', 'Penerbitan SK Pembatalan', 'Laporan Penyelesaian Kasus'];
const STATUS_MAP = { 0: { label: 'Usulan Masuk', cls: 'status-0' }, 1: { label: 'Telaah Staff', cls: 'status-1' }, 2: { label: 'Penelitian Lapang', cls: 'status-2' }, 3: { label: 'Gelar Kasus', cls: 'status-3' }, 4: { label: 'Penerbitan SK', cls: 'status-4' }, 5: { label: 'Selesai', cls: 'status-5' } };
const HOLIDAYS_2025 = { '2025-01-01': 'Tahun Baru Masehi', '2025-01-27': 'Isra Mi\'raj', '2025-01-29': 'Tahun Baru Imlek', '2025-03-29': 'Nyepi', '2025-03-31': 'Idul Fitri', '2025-04-01': 'Idul Fitri', '2025-05-01': 'Hari Buruh', '2025-08-17': 'Hari Kemerdekaan RI', '2025-12-25': 'Natal' };

function saveData() { 
  localStorage.setItem('sipentas-cases', JSON.stringify(cases)); 
  localStorage.setItem('sipentas-events', JSON.stringify(calendarEvents)); 
}


// ══════════════════════════════════════════════════════════
// 6. NAVIGASI, DASHBOARD & RENDER TABEL
// ══════════════════════════════════════════════════════════
let currentPage = 'dashboard'; let prevPage = 'dashboard';
const crumbMap = { 'dashboard': 'Beranda / <span>Dashboard</span>', 'list-cacat': 'Permohonan / <span>Cacat Administrasi</span>', 'list-putusan': 'Permohonan / <span>Putusan Pengadilan</span>', 'tambah': 'Permohonan / <span>Tambah Baru</span>', 'detail': 'Permohonan / <span>Detail Kasus</span>', 'kalender': 'Informasi / <span>Kalender Kegiatan</span>', 'tahapan': 'Informasi / <span>Alur Tahapan</span>', 'pengaturan': 'Sistem / <span>Pengaturan Akun</span>' };

function navigateTo(page, param) {
  prevPage = currentPage; currentPage = page;
  document.querySelector('.sidebar')?.classList.remove('open'); document.querySelector('.sidebar-overlay')?.classList.remove('active');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-' + page)?.classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); if (n.getAttribute('onclick')?.includes("'" + page + "'")) n.classList.add('active'); });
  document.getElementById('page-crumb').innerHTML = crumbMap[page] || `<span>${page}</span>`;
  
  // Kosongkan global search bar saat berpindah halaman
  const globalSearch = document.getElementById('global-search');
  if (globalSearch) globalSearch.value = '';

  if (page === 'list-cacat') renderTable('cacat'); 
  if (page === 'list-putusan') renderTable('putusan');
  if (page === 'dashboard') { renderDashboard(); renderMiniCal(); } 
  if (page === 'tambah') { resetForm(param); initWilayah(); } 
  if (page === 'kalender') { renderFullCal(); renderEventsList(); } 
  if (page === 'tahapan') renderAlur();
  
  updateStats();
}

function updateStats() {
  document.getElementById('stat-total').textContent = cases.length;
  document.getElementById('stat-cacat').textContent = cases.filter(c => c.jenis === 'cacat').length;
  document.getElementById('stat-putusan').textContent = cases.filter(c => c.jenis === 'putusan').length;
  document.getElementById('stat-selesai').textContent = cases.filter(c => c.currentStep >= 5).length;
  document.getElementById('badge-cacat').textContent = cases.filter(c => c.jenis === 'cacat').length;
  document.getElementById('badge-putusan').textContent = cases.filter(c => c.jenis === 'putusan').length;
}

function renderDashboard() {
  const tbody = document.getElementById('recent-cases-tbody');
  const recent = [...cases].sort((a,b) => new Date(b.tglUsulan) - new Date(a.tglUsulan)).slice(0,8);
  if (!recent.length) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);padding:32px">Belum ada data</td></tr>'; return; }
  tbody.innerHTML = recent.map(c => `<tr onclick="openDetail('${c.id}')"><td><code style="font-size:12px;background:var(--surface);padding:2px 7px;border-radius:4px">${escapeHTML(c.nomorberkas)}</code></td><td style="font-size:12px">${escapeHTML(c.pemohon)}</td><td><span class="badge ${c.jenis === 'cacat' ? 'badge-admin' : 'badge-court'}"><span class="badge-dot" style="background:${c.jenis==='cacat'?'var(--gray-dark)':'var(--white)'}"></span> ${c.jenis === 'cacat' ? 'Cacat Adm.' : 'Putusan PN'}</span></td><td style="font-size:12px">${escapeHTML(c.kantah)}</td><td><span class="status-badge ${STATUS_MAP[c.currentStep]?.cls || 'status-0'}">${STATUS_MAP[c.currentStep]?.label || '-'}</span></td></tr>`).join('');
}

function renderTable(type) {
  const tbody = document.getElementById('tbody-' + type); const search = (document.getElementById('global-search')?.value || '').toLowerCase(); const filterStatus = document.getElementById('filter-status-' + type)?.value;
  let filtered = cases.filter(c => c.jenis === type);
  if (search) filtered = filtered.filter(c => c.nomorberkas.toLowerCase().includes(search) || c.pemohon.toLowerCase().includes(search) || (c.desa||'').toLowerCase().includes(search) || (c.noputs||'').toLowerCase().includes(search));
  if (filterStatus !== '' && filterStatus !== undefined) filtered = filtered.filter(c => String(c.currentStep) === String(filterStatus));

  if (!filtered.length) { tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;color:var(--text-muted);padding:40px">Tidak ada data</td></tr>`; return; }
  tbody.innerHTML = filtered.map(c => {
    const progress = Math.round(((c.currentStep) / 5) * 100); const steps = Array.from({length:5}, (_,i) => `<div class="pipe-step ${i < c.currentStep ? 'done' : i === c.currentStep ? 'active' : ''}"></div>`).join('');
    const extraCol = type === 'putusan' ? `<td style="font-size:12px">${escapeHTML(c.noputs||'-')}</td>` : `<td style="font-size:12px">${escapeHTML(c.nosert||'-')}</td>`;
    const domisili = [c.desa, c.kecamatan].filter(Boolean).join(', ');

    return `<tr onclick="openDetail('${c.id}')"><td><code style="font-size:12px;background:var(--surface);padding:2px 7px;border-radius:4px">${escapeHTML(c.nomorberkas)}</code></td><td style="font-size:12px">${escapeHTML(c.kantah)}</td><td style="font-size:12px">${escapeHTML(c.pemohon)}</td>${extraCol}<td style="font-size:12px">${escapeHTML(domisili||'-')}</td><td style="font-size:12px">${fmtDate(c.tglUsulan)}</td><td><span class="status-badge ${STATUS_MAP[c.currentStep]?.cls}">${STATUS_MAP[c.currentStep]?.label}</span></td><td style="min-width:80px"><div style="display:flex;flex-direction:column;gap:3px"><div class="pipeline">${steps}</div><span style="font-size:10px;color:var(--text-muted)">${progress}%</span></div></td><td onclick="event.stopPropagation()"><div style="display:flex;gap:6px"><button class="btn btn-secondary btn-sm" onclick="openDetail('${c.id}')">Detail</button><button class="btn btn-danger btn-sm" onclick="deleteCase('${c.id}')">Hapus</button></div></td></tr>`;
  }).join('');
}
function filterTable(type) { renderTable(type); }


// ══════════════════════════════════════════════════════════
// 7. FORM TAMBAH KASUS & UPDATE TAHAPAN
// ══════════════════════════════════════════════════════════
let currentFormTab = 'info'; 
const formTabs = ['info', 'detail']; 

function switchFormTab(tab) { showFormTab(tab); }
function showFormTab(tab) { 
  formTabs.forEach(t => { document.getElementById('form-tab-' + t).style.display = t === tab ? '' : 'none'; }); 
  document.querySelectorAll('.tabs .tab').forEach((btn, i) => { btn.classList.toggle('active', formTabs[i] === tab); }); 
  const idx = formTabs.indexOf(tab); 
  document.getElementById('btn-prev-tab').style.display = idx === 0 ? 'none' : ''; 
  document.getElementById('btn-next-tab').style.display = idx === formTabs.length - 1 ? 'none' : ''; 
  document.getElementById('btn-submit').style.display = idx === formTabs.length - 1 ? '' : 'none'; 
  currentFormTab = tab; 
}
function nextFormTab() { const idx = formTabs.indexOf(currentFormTab); if (idx < formTabs.length - 1) showFormTab(formTabs[idx + 1]); }
function prevFormTab() { const idx = formTabs.indexOf(currentFormTab); if (idx > 0) showFormTab(formTabs[idx - 1]); }

function resetForm(preselect) { 
  document.getElementById('form-permohonan').reset(); 
  if (preselect) document.getElementById('f-jenis').value = preselect; 
  showFormTab('info'); 
  togglePutsanField(); 
  document.getElementById('f-jenis').addEventListener('change', togglePutsanField); 
  
  // Reload Kab dari database
  initWilayah();
  // Kosongkan dan matikan dropdown wilayah selain kabupaten
  document.getElementById('f-kecamatan').innerHTML = '<option value="">-- Pilih Kecamatan --</option>';
  document.getElementById('f-kecamatan').disabled = true;
  document.getElementById('f-desa').innerHTML = '<option value="">-- Pilih Desa/Kelurahan --</option>';
  document.getElementById('f-desa').disabled = true;
}

function togglePutsanField() {
  const type = document.getElementById('f-jenis').value;
  document.getElementById('f-noputs-group').style.display = type === 'putusan' ? 'block' : 'none';
}

async function submitForm(e) { 
  e.preventDefault(); 
  const jenis = document.getElementById('f-jenis').value; 
  if (!jenis) { showToast('Pilih jenis permohonan!', 'error'); return; } 

  // Membaca Dokumen Usulan
  const fileUsulanInput = document.getElementById('f-dokumenusulan');
  let dokumenUsulanData = { file: null, name: '' };
  if (fileUsulanInput.files.length > 0) {
    const file = fileUsulanInput.files[0];
    if (file.type !== 'application/pdf') { showToast('Dokumen Usulan harus PDF!', 'error'); return; }
    if (file.size > 2 * 1024 * 1024) { showToast('Dokumen Usulan maks 2MB!', 'error'); return; }
    try { dokumenUsulanData.file = await readFileAsBase64(file); dokumenUsulanData.name = file.name; } 
    catch(err) { showToast('Gagal membaca Dokumen Usulan', 'error'); return; }
  }
  
  // Membaca Buku Tanah
  const fileBTInput = document.getElementById('f-dokumenbt');
  let dokumenbtData = { file: null, name: '' };
  if (fileBTInput.files.length > 0) {
    const file = fileBTInput.files[0];
    if (file.type !== 'application/pdf') { showToast('Buku Tanah harus PDF!', 'error'); return; }
    if (file.size > 2 * 1024 * 1024) { showToast('Buku Tanah maks 2MB!', 'error'); return; }
    try { dokumenbtData.file = await readFileAsBase64(file); dokumenbtData.name = file.name; } 
    catch(err) { showToast('Gagal membaca Buku Tanah', 'error'); return; }
  }

  // Tahapan Kosong (Mulai dari tahap 0)
  const initialTahapan = TAHAPAN_LABELS.map(() => ({ date: '', note: '', file: null, fileName: '' }));

  cases.push({ 
    id: 'c' + Date.now(), 
    nomorberkas: document.getElementById('f-nomorberkas').value, 
    jenis, kantah: document.getElementById('f-kantah').value, 
    tglUsulan: document.getElementById('f-tglUsulan').value, 
    pemohon: document.getElementById('f-pemohon').value, 
    kontak: document.getElementById('f-kontak').value, 
    pj: document.getElementById('f-pj').value, 
    noputs: document.getElementById('f-noputs').value, 
    dokumenUsulan: dokumenUsulanData,
    pemeganghak: document.getElementById('f-pemeganghak').value,
    jenissert: document.getElementById('f-jenissert').value, 
    nosert: document.getElementById('f-nosert').value, 
    luas: document.getElementById('f-luas').value, 
    kabupaten: document.getElementById('f-kabupaten').value,
    kecamatan: document.getElementById('f-kecamatan').value,
    desa: document.getElementById('f-desa').value,
    dokumenbt: dokumenbtData,
    uraian: document.getElementById('f-uraian').value, 
    tahapan: initialTahapan, 
    currentStep: 0, 
    createdAt: new Date().toISOString() 
  }); 

  saveData(); updateStats(); showToast('Permohonan berhasil disimpan!', 'success'); 
  navigateTo(jenis === 'cacat' ? 'list-cacat' : 'list-putusan'); 
}

let updatingCaseId = ''; let updatingStepIdx = 0;
function openUpdateTahapan(id, stepIdx) { updatingCaseId = id; updatingStepIdx = stepIdx; const c = cases.find(x => x.id === id); const label = TAHAPAN_LABELS[stepIdx]; const existingFileLabel = c.tahapan?.[stepIdx]?.fileName ? `<div style="font-size:11px;color:#1B5E20;margin-top:4px;font-weight:600;">Terunggah: ${escapeHTML(c.tahapan[stepIdx].fileName)}</div>` : ''; document.getElementById('modal-tahapan-body').innerHTML = `<p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Tahapan: <strong style="color:var(--text)">${label}</strong></p><div class="form-group" style="margin-bottom:12px"><label for="upd-date">Tanggal Penyelesaian *</label><input type="date" class="form-control" id="upd-date" value="${c.tahapan?.[stepIdx]?.date || ''}"></div><div class="form-group" style="margin-bottom:12px"><label for="upd-note">Catatan</label><textarea class="form-control" id="upd-note" placeholder="Catatan proses...">${escapeHTML(c.tahapan?.[stepIdx]?.note || '')}</textarea></div><div class="form-group"><label for="upd-file">Unggah Dokumen PDF (Maks 2MB)</label><input type="file" class="form-control" id="upd-file" accept="application/pdf" style="padding: 7px 14px; font-size: 12px;">${existingFileLabel}</div>`; openModal('modal-tahapan'); }

async function saveTahapanUpdate() { const date = document.getElementById('upd-date').value; const note = document.getElementById('upd-note').value; const fileInput = document.getElementById('upd-file'); if (!date) { showToast('Masukkan tanggal!', 'error'); return; } const c = cases.find(x => x.id === updatingCaseId); if (!c) return; if (!c.tahapan) c.tahapan = []; let fileData = c.tahapan[updatingStepIdx]?.file || null; let fileName = c.tahapan[updatingStepIdx]?.fileName || ''; if (fileInput.files.length > 0) { const file = fileInput.files[0]; if (file.type !== 'application/pdf') { showToast('Hanya file PDF!', 'error'); return; } if (file.size > 2 * 1024 * 1024) { showToast('Ukuran maksimal 2MB!', 'error'); return; } try { fileData = await readFileAsBase64(file); fileName = file.name; } catch(e) { showToast('Gagal membaca file', 'error'); return; } } c.tahapan[updatingStepIdx] = { date, note, file: fileData, fileName }; c.currentStep = c.tahapan.reduce((acc, t, i) => t?.date ? i + 1 : acc, 0); saveData(); closeModal('modal-tahapan'); showToast('Tahapan diperbarui!', 'success'); openDetail(updatingCaseId); }

function deleteCase(id) { if (!confirm('Hapus data permohonan ini?')) return; cases = cases.filter(c => c.id !== id); saveData(); updateStats(); renderTable(currentPage === 'list-cacat' ? 'cacat' : 'putusan'); showToast('Data dihapus'); }


// ══════════════════════════════════════════════════════════
// 8. TAMPILAN DETAIL KASUS
// ══════════════════════════════════════════════════════════
function openDetail(id) {
  const c = cases.find(x => x.id === id); if (!c) return; prevPage = currentPage; currentPage = 'detail';

  const steps = TAHAPAN_LABELS.map((label, i) => {
    let isCompleted = !!c.tahapan?.[i]?.date;
    let hasFile = !!c.tahapan?.[i]?.file;
    let cls = isCompleted ? 'success' : (i === c.currentStep ? 'active' : 'pending');

    let dateStr = c.tahapan?.[i]?.date ? fmtDate(c.tahapan[i].date) : '';
    let dateHtml = dateStr ? `<div class="step-date">${dateStr}</div>` : '';
    let noteStr = c.tahapan?.[i]?.note || '';
    let shortNote = noteStr.length > 55 ? noteStr.substring(0, 55) + '...' : noteStr;
    let noteHtml = noteStr ? `<div class="step-note">${escapeHTML(shortNote)}</div>` : '';
    let checkIcon = isCompleted ? `<svg viewBox="0 0 24 24" width="16" height="16" stroke="#1B5E20" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round" style="margin-left:8px"><polyline points="20 6 9 17 4 12"></polyline></svg>` : '';
    
    let actionBtn = '';
    if (i === c.currentStep) actionBtn = `<button class="btn btn-primary btn-sm" style="margin-left:auto;flex-shrink:0" onclick="openUpdateTahapan('${id}',${i})">Update</button>`;
    else if (isCompleted) actionBtn = `<button class="btn btn-secondary btn-sm" style="margin-left:auto;flex-shrink:0" onclick="viewTahapan('${id}',${i})">Lihat Detail</button>`;

    return `<div class="step-item"><div class="step-num ${cls}">${i+1}</div><div class="step-content"><div class="step-title">${label} ${checkIcon}</div>${dateHtml}${noteHtml}</div>${actionBtn}</div>`;
  }).join('');

  let btnUnduhUsulan = '';
  if(c.dokumenUsulan && c.dokumenUsulan.file) {
    btnUnduhUsulan = `<a href="${c.dokumenUsulan.file}" download="${c.dokumenUsulan.name}" class="btn btn-secondary btn-sm" style="font-size:11px; padding:6px 12px; text-decoration:none;"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" style="margin-right:6px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg> Unduh Dokumen Usulan</a>`;
  }

  let btnUnduhBT = '';
  if(c.dokumenbt && c.dokumenbt.file) {
    btnUnduhBT = `<a href="${c.dokumenbt.file}" download="${c.dokumenbt.name}" class="btn btn-secondary btn-sm" style="font-size:11px; padding:6px 12px; text-decoration:none;"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" style="margin-right:6px;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg> Unduh Buku Tanah</a>`;
  }

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-header">
      <div class="detail-case-id">ID BERKAS</div>
      <div class="detail-title">${escapeHTML(c.nomorberkas)}</div>
      <div class="detail-metas">
        <div class="detail-meta-item"><strong>Pemohon:</strong>${escapeHTML(c.pemohon)}</div>
        <div class="detail-meta-item"><strong>PJ Berkas:</strong>${escapeHTML(c.pj||'-')}</div>
        <div class="detail-meta-item"><strong>Jenis:</strong>${c.jenis === 'cacat' ? 'Cacat Administrasi' : 'Putusan Pengadilan'}</div>
        <div class="detail-meta-item"><strong>Kantah:</strong>${escapeHTML(c.kantah)}</div>
        <div class="detail-meta-item"><strong>Tgl. Usulan:</strong>${fmtDate(c.tglUsulan)}</div>
      </div>
      <div style="margin-top:20px; display:flex; gap:10px;">${btnUnduhUsulan}</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 360px;gap:20px" class="dashboard-grid">
      <div class="card"><div class="card-header"><span class="card-title">Riwayat Tahapan</span></div><div class="card-body"><div class="stepper">${steps}</div></div></div>
      <div style="display:flex;flex-direction:column;gap:16px">
        <div class="card">
          <div class="card-header"><span class="card-title">Informasi Kasus & Objek</span></div>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-item" style="grid-column:1/-1;"><label>Nama Pemegang Hak</label><span style="font-weight:600;">${escapeHTML(c.pemeganghak||'-')}</span></div>
              <div class="info-item"><label>Jenis Sertipikat</label><span>${escapeHTML(c.jenissert||'-')}</span></div>
              <div class="info-item"><label>No. Sertipikat</label><span>${escapeHTML(c.nosert||'-')}</span></div>
              <div class="info-item"><label>Luas Tanah</label><span>${c.luas ? formatNumber(c.luas) + ' m²' : '-'}</span></div>
              ${c.jenis === 'putusan' ? `<div class="info-item"><label>No. Putusan</label><span>${escapeHTML(c.noputs||'-')}</span></div>` : ''}
              
              <div class="info-item" style="grid-column:1/-1; margin-top:8px; border-top:1px solid var(--border); padding-top:12px;">
                <label style="margin-bottom:8px;">Lokasi / Wilayah Administrasi Objek</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                  <div><span style="font-size:11px; color:var(--text-muted); display:block;">Desa/Kelurahan</span><span style="font-size:13px;">${escapeHTML(c.desa||'-')}</span></div>
                  <div><span style="font-size:11px; color:var(--text-muted); display:block;">Kecamatan</span><span style="font-size:13px;">${escapeHTML(c.kecamatan||'-')}</span></div>
                  <div style="grid-column:1/-1;"><span style="font-size:11px; color:var(--text-muted); display:block;">Kota/Kabupaten</span><span style="font-size:13px;">${escapeHTML(c.kabupaten||'-')}</span></div>
                </div>
              </div>
            </div>
            ${btnUnduhBT ? `<div style="margin-top:16px;">${btnUnduhBT}</div>` : ''}
          </div>
        </div>
        ${c.uraian ? `<div class="card"><div class="card-header"><span class="card-title">Uraian Singkat Kasus</span></div><div class="card-body"><p style="font-size:13px;line-height:1.7;color:var(--text-sub)">${escapeHTML(c.uraian)}</p></div></div>` : ''}
        <div class="card"><div class="card-header"><span class="card-title">Status Saat Ini</span></div><div class="card-body"><span class="status-badge ${STATUS_MAP[c.currentStep]?.cls}" style="font-size:13px;padding:6px 14px">${STATUS_MAP[c.currentStep]?.label}</span><div style="margin-top:12px"><div class="progress-bar"><div class="progress-fill" style="width:${Math.round((c.currentStep/5)*100)}%"></div></div><div style="font-size:11px;color:var(--text-muted);margin-top:4px">${Math.round((c.currentStep/5)*100)}% selesai</div></div></div></div>
      </div>
    </div>`;
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById('page-detail').classList.add('active'); document.getElementById('page-crumb').innerHTML = crumbMap['detail'];
}
function goBackFromDetail() { navigateTo(prevPage === 'detail' ? 'dashboard' : prevPage); }

function viewTahapan(id, stepIdx) {
  const c = cases.find(x => x.id === id); if (!c) return; const t = c.tahapan[stepIdx]; const label = TAHAPAN_LABELS[stepIdx];
  let fileHtml = '<p style="font-size:13px;color:var(--text-muted);font-style:italic;">Tidak ada dokumen pendukung yang diunggah.</p>';
  if (t.file) fileHtml = `<div style="background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-sm); padding:16px; display:flex; align-items:center; justify-content:space-between;"><div style="display:flex; align-items:center; gap:12px; min-width:0;"><div style="width:40px; height:40px; flex-shrink:0; background:#FFEbee; color:#c0392b; border-radius:8px; display:flex; align-items:center; justify-content:center;"><svg viewBox="0 0 24 24" width="20" height="20" stroke="currentColor" stroke-width="2" fill="none"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></div><div style="min-width:0; overflow:hidden;"><div style="font-size:13px; font-weight:600; white-space:nowrap; text-overflow:ellipsis; overflow:hidden;">${escapeHTML(t.fileName)}</div><div style="font-size:11px; color:var(--text-muted);">Dokumen PDF Terverifikasi</div></div></div><a href="${t.file}" download="${t.fileName}" class="btn btn-primary btn-sm" style="text-decoration:none; flex-shrink:0;">Unduh</a></div>`;
  const statusBadge = `<span style="display:inline-flex; align-items:center; gap:6px; background:#1B5E20; color:white; padding:5px 14px; border-radius:20px; font-size:12px; font-weight:600; box-shadow: 0 2px 8px rgba(27,94,32,0.2);"><svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg> Tuntas</span>`;
  document.getElementById('modal-view-tahapan-body').innerHTML = `<div style="margin-bottom:20px;"><div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px;">Nama Tahapan</div><div style="font-size:18px; font-weight:600;">${label}</div></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;"><div><div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:4px;">Tanggal Penyelesaian</div><div style="font-size:15px; font-weight:500;">${fmtDate(t.date)}</div></div><div><div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px;">Status Validasi</div>${statusBadge}</div></div><div style="margin-bottom:24px;"><div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:6px;">Catatan / Keterangan Petugas</div><div style="font-size:13.5px; line-height:1.6; background:var(--surface); padding:12px 16px; border-radius:var(--radius-sm); color:var(--text-sub);">${escapeHTML(t.note) || '<em>(Tidak ada catatan)</em>'}</div></div><div><div style="font-size:11px; font-weight:700; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:8px;">Bukti Dokumen</div>${fileHtml}</div>`;
  document.getElementById('btn-edit-tahapan').onclick = function() { closeModal('modal-view-tahapan'); openUpdateTahapan(id, stepIdx); };
  openModal('modal-view-tahapan');
}


// ══════════════════════════════════════════════════════════
// 9. KALENDER & ALUR TAHAPAN
// ══════════════════════════════════════════════════════════
const MONTHS = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember']; let miniCalDate = new Date(); let fullCalDate = new Date();
function dateKey(y, m, d) { return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; } function getEventsForDate(key) { return calendarEvents.filter(e => e.date === key); }
function renderMiniCal() { const d = miniCalDate; const y = d.getFullYear(), m = d.getMonth(); document.getElementById('mini-cal-label').textContent = `${MONTHS[m]} ${y}`; const first = new Date(y, m, 1).getDay(); const days = new Date(y, m + 1, 0).getDate(); const today = new Date(); let html = ''; let total = Math.ceil((first + days) / 7) * 7; for (let i = 0; i < total; i++) { const dayNum = i - first + 1; const isOther = dayNum < 1 || dayNum > days; const key = dateKey(y, m, dayNum); const holiday = HOLIDAYS_2025[key]; const events = getEventsForDate(key); let cls = 'cal-cell' + (isOther ? ' other-month' : '') + (!isOther && new Date(y, m, dayNum).toDateString() === today.toDateString() ? ' today' : '') + (holiday ? ' holiday' : '') + (!isOther && events.length ? ' has-event' : ''); html += `<div class="${cls}" onclick="${!isOther ? `openDayModal('${key}')` : ''}">${isOther ? '' : dayNum}${holiday ? `<div class="cal-tooltip">${holiday}</div>` : ''}</div>`; } document.getElementById('mini-cal-grid').innerHTML = html; }
function miniCalPrev() { miniCalDate = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth() - 1, 1); renderMiniCal(); } function miniCalNext() { miniCalDate = new Date(miniCalDate.getFullYear(), miniCalDate.getMonth() + 1, 1); renderMiniCal(); }
function renderFullCal() { const d = fullCalDate; const y = d.getFullYear(), m = d.getMonth(); document.getElementById('full-cal-label').textContent = `${MONTHS[m]} ${y}`; const first = new Date(y, m, 1).getDay(); const days = new Date(y, m + 1, 0).getDate(); const today = new Date(); let html = ''; let total = Math.ceil((first + days) / 7) * 7; for (let i = 0; i < total; i++) { const dayNum = i - first + 1; const isOther = dayNum < 1 || dayNum > days; const key = dateKey(y, m, dayNum); const holiday = HOLIDAYS_2025[key]; const events = !isOther ? getEventsForDate(key) : []; const isToday = !isOther && new Date(y, m, dayNum).toDateString() === today.toDateString(); html += `<div class="cal-cell" style="${isOther ? 'opacity:0.3;' : ''}${isToday ? 'background:var(--black);color:white;border-radius:6px;' : ''}min-height:64px;align-items:flex-start;padding:6px;border:1px solid var(--border);border-radius:4px;flex-direction:column;gap:3px" onclick="${!isOther ? `openDayModal('${key}')` : ''}"><div style="${(i % 7 === 0 || holiday) ? 'color:#c0392b;' : ''}${isToday ? 'color:white;' : ''}font-size:12px;font-weight:${isToday||holiday?'700':'400'}">${isOther ? '' : dayNum}</div>${holiday && !isOther ? `<div style="font-size:9px;color:#c0392b;">${holiday.slice(0,20)}</div>` : ''}${events.slice(0,2).map(e => `<div style="font-size:9px;background:var(--black);color:white;padding:1px 5px;border-radius:3px;overflow:hidden">${escapeHTML(e.title).slice(0,14)}</div>`).join('')}</div>`; } document.getElementById('full-cal-grid').innerHTML = html; renderEventsList(); }
function fullCalPrev() { fullCalDate = new Date(fullCalDate.getFullYear(), fullCalDate.getMonth() - 1, 1); renderFullCal(); } function fullCalNext() { fullCalDate = new Date(fullCalDate.getFullYear(), fullCalDate.getMonth() + 1, 1); renderFullCal(); } function fullCalToday() { fullCalDate = new Date(); renderFullCal(); }
function openDayModal(key) { const [y, m, d] = key.split('-'); const holiday = HOLIDAYS_2025[key]; const events = getEventsForDate(key); document.getElementById('modal-agenda-title').textContent = `Kegiatan — ${parseInt(d)} ${MONTHS[parseInt(m)-1]} ${y}`; let html = holiday ? `<div style="background:#FFF5F5;border:1px solid #FFD0CC;border-radius:8px;padding:12px 16px;margin-bottom:14px;color:#c0392b;font-weight:500;font-size:13px">🎌 ${holiday}</div>` : ''; events.forEach(e => { html += `<div style="border:1px solid var(--border);border-radius:8px;padding:12px 16px;margin-bottom:10px"><div style="font-size:14px;font-weight:500;">${escapeHTML(e.title)}</div><button onclick="deleteEvent('${e.id}');closeModal('modal-agenda')" style="margin-top:8px;font-size:11px;color:#c0392b;background:none;border:none;cursor:pointer;padding:0">Hapus Kegiatan</button></div>`; }); html += `<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border)"><input type="text" class="form-control" id="quick-event-title" placeholder="Judul..." style="margin-bottom:8px"><button class="btn btn-primary" style="width:100%;font-size:13px" onclick="quickAddEvent('${key}')">Tambah</button></div>`; document.getElementById('modal-agenda-body').innerHTML = html; openModal('modal-agenda'); }
function addCalendarEvent() { const d = document.getElementById('new-event-date').value, t = document.getElementById('new-event-title').value; if(d&&t) { calendarEvents.push({id:'ev'+Date.now(), date:d, title:t}); saveData(); renderFullCal(); renderMiniCal(); showToast('Tersimpan!','success'); } } function quickAddEvent(key) { const t = document.getElementById('quick-event-title').value; if(t) { calendarEvents.push({id:'ev'+Date.now(), date:key, title:t}); saveData(); renderFullCal(); renderMiniCal(); closeModal('modal-agenda'); showToast('Tersimpan!','success'); } } function deleteEvent(id) { calendarEvents = calendarEvents.filter(e => e.id !== id); saveData(); renderFullCal(); renderMiniCal(); } function renderEventsList() { document.getElementById('events-list-panel').innerHTML = '<p style="font-size:12px;color:#999;text-align:center">Daftar agenda disederhanakan di tampilan ini.</p>'; }
function renderAlur() { const steps1 = TAHAPAN_LABELS.map((label, i) => `<div class="step-item"><div class="step-num done">${i+1}</div><div class="step-content"><div class="step-title">${label}</div></div></div>`).join(''); document.getElementById('stepper-alur').innerHTML = steps1; document.getElementById('stepper-alur-2').innerHTML = steps1; }

// ══════════════════════════════════════════════════════════
// 10. INISIALISASI APLIKASI
// ══════════════════════════════════════════════════════════
if (cases.length === 0) { 
  cases = [ { id: 'c1', nomorberkas: 'BPN/001', jenis: 'cacat', kantah: 'Kota Mataram', tglUsulan: '2025-02-10', pemohon: 'H. Ahmad', pj: 'Budi Santoso', pemeganghak: 'H. Ahmad', luas: '250', kabupaten: 'Kota Mataram', kecamatan: 'Sekarbela', desa: 'Jempong Baru', tahapan: [{date:'2025-02-10', note:'Berkas dianalisa'}], currentStep: 1 } ]; 
  saveData(); 
}

initWilayah();      // Inisialisasi awal dropdown wilayah
updateStats();      
renderDashboard();  
renderMiniCal();    
renderAlur();       

// Inisialisasi Tampilan Berdasarkan Status Login
checkLogin();

</script>
</body>
</html>
